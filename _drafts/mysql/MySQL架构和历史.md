###MySQL架构和历史

#### MySQL逻辑架构

下图是MySQL服务器的逻辑架构图。

![MySQL逻辑架构图][logic-arch]

上图主要对MySQL的功能分了三层，客户端请求到来后，到达第二层，在这里完成了查询语言的解释、分析、优化、缓存和内置函数的处理，同时在这一层也提供了跨存储引擎的功能，如存储过程、触发器、视图。

第三层包含了各种存储引擎，这些存储引擎负责实际数据的存储与检索，MySQL服务器（第二层）通过提供的API与这些存储引擎进行通信，注意的是，在与存储引擎交互的过程中使用的是存储引擎API，而不是SQL。

####并发控制

在并发控制上，MySQL主要在两个层次进行控制： **服务器层** 和 **存储引擎层**。

通常使用锁控制并发文件读写，共享锁（读锁）和排它锁（写锁），锁的使用必然会造成资源的消耗，因此，良好的锁策略是至关重要的，在MySQL服务器实现中，为了更大的灵活性，并没有提供可选的锁机制，而是由存储引擎自己实现自己的锁机制。

> MySQL并不是没有实现锁机制，而是将对数据的锁教给存储引擎，而MySQL本身也使用了一系列的表级锁，比如`ALTER TABLE`就是存储引擎无关的。

> 需要注意的是，行级锁是完全在存储引擎实现的，当前支持行级锁的存储引擎有InnoDB和XtraDB等。

####事务
在MySQL中，开启一个事务使用`START TRANSACTION`，当事务执行成功时，执行`COMMIT`提交事务，当时失败时，使用`ROLLBACK`回滚事务。

事务的四个特性（ACID）：

- 原子性(Atomicity)
	一个事务是一个基本的操作单元，不可分割，要么全部成功，要么全部回滚。

- 一致性(Consistency)
	事务的执行结果必须是使数据库从一个一致性状态到另一个一致性状态，一致性和原子性是密切相关的。

- 隔离性(Isolation)
	一个事务的执行结果在还没有提交之前，对其他事务是不可见的。

- 持久性(Durability)
	事务一旦提交，事务的修改是持久化的。

> 在使用不支持事务的存储引擎中，要保证数据是完整的话，可以使用表级锁`LOCK TABLES`，当然，最好不要这么做，效率是很低的。

隔离性是非常复杂的，SQL标准中定义了四个隔离级别。隔离级别越低，通常意味着并发性能越好，开销越小。

- READ UNCOMMITTED (未提交读，脏读)
	允许脏读取，但不允许更新丢失。如果一个事务已经开始写数据，则另外一个事务则不允许同时进行写操作，但允许其他事务读此行数据。该隔离级别可以通过“排他写锁”实现。

- READ COMMITTED (提交读)
	允许不可重复读取，但不允许脏读取。这可以通过“瞬间共享读锁”和“排他写锁”实现。读取数据的事务允许其他事务继续访问该行数据，但是未提交的写事务将会禁止其他事务访问该行。

- REPEATABLE READ (可重复读)
	禁止不可重复读取和脏读取，但是有时可能出现幻影数据。这可以通过“共享读锁”和“排他写锁”实现。读取数据的事务将会禁止写事务（但允许读事务），写事务则禁止任何其他事务。**该隔离级别是MySQL默认的隔离级别**。（在InnoDB和XtraDB中解决了幻读的问题）。

- SERIALIZABLE (序列化)
	序列化是最高的隔离级别，它通过强制事务按照顺序执行以避免冲突解决了幻读的问题。实际上，序列化对它读取的没一行数据都加了一个锁。在这种隔离级别下，可能会经常出现超时和锁竞争。

![ANSI SQL isolation levels][isolation-level]

MySQL中提供了两个支持事务的存储引擎: **InnoDB** 和 **NDB Cluster**，除了官方提供的存储引擎外，比较著名的支持事务的第三方存储引擎还有**XtraDB**和**PBXT**。

####存储引擎

InnoDB表是基于聚簇索引建立的，聚簇索引对主键具有很高的查询性能，不过它的二级索引中必须包含主键列，所以如果主键列很大的话，其它的索引也会很大，因此，如果表上的索引比较多的话，主键应该尽可能的小。

MyISAM会将表存储在两个文件中：数据文件和索引文件，分别以.MYD和.MYI为扩展名。MyISAM对整张表加锁，而不会对行加锁。读取时会对所有读取到的表加上共享锁，而写入的时候则会对表添加排它锁。

如果在表创建并且导入数据之后，不会在进行修改操作，那么这样的表适应采用MyISAM压缩表。压缩表中的数据是不能被修改的，它可以极大的减少磁盘空间的占用，因此也可以减少磁盘I/O，从而提升查询性能。压缩表也支持索引，但是索引也是只读的。压缩表中的记录是独立压缩的，因此读取单行时并不需要去解压整个表。

Archive存储引擎只支持INSERT和SELECT操作，在MySQL5.1之前也不支持索引。Archive引擎会缓存所有的写操作并利用zlib对插入的行进行压缩，所以比MyISAM的磁盘I/O更少。但是每次SELECT都需要全表扫描。所以Archive适合用作日志和数据采集类的应用，这类应用做数据分析时往往需要全表扫描。


[logic-arch]:./resources/mysql-logical-architecture.png
[isolation-level]:./resources/ANSI%20SQL%20isolation%20levels.png